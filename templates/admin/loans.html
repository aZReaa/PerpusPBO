{% extends "admin/base.html" %}

{% block title %}Kelola Peminjaman{% endblock %}

{% block content %}
<style>
    /* Additional loan management dark theme fixes */
    .main, .content, .admin-content, .content-wrapper {
        background: transparent !important;
    }
    
    /* Fix for search filter section */
    .search-filter-section-modern {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color-dark) !important;
        border-radius: 12px;
        margin: 20px 0;
        padding: 20px;
    }
    
    /* Fix for stats grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color-dark) !important;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent-color);
    }
    
    .stat-warning {
        border-color: var(--danger-color) !important;
    }
      .stat-icon {
        font-size: 2rem;
    }
    
    /* Status badge styling */
    .status-badge.status-overdue {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .status-badge.status-due-today {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    /* Modal styling */
    .modal-content {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color-dark) !important;
        color: var(--text-color) !important;
    }
    
    .modal-header {
        border-bottom: 1px solid var(--border-color-dark) !important;
    }
    
    .modal-footer {
        border-top: 1px solid var(--border-color-dark) !important;
    }
    
    .form-control, .form-select {
        background: var(--bg-secondary-dark) !important;
        border: 1px solid var(--border-color-dark) !important;
        color: var(--text-color) !important;
    }
    
    .form-control:focus, .form-select:focus {
        background: var(--bg-secondary-dark) !important;
        border-color: var(--accent-color) !important;
        color: var(--text-color) !important;
        box-shadow: 0 0 0 0.2rem rgba(127, 90, 240, 0.25) !important;
    }
    
    .form-label {
        color: var(--text-color) !important;
        font-weight: 600;
    }
      .form-check-input:checked {
        background-color: var(--accent-color) !important;
        border-color: var(--accent-color) !important;
    }
    
    /* Status info styling */
    .status-info {
        color: var(--text-color) !important;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(127, 90, 240, 0.1);
        border: 1px solid rgba(127, 90, 240, 0.2);
    }
    
    /* Tombol selesai styling */
    .btn-selesai {
        color: var(--text-color) !important;
        background: rgba(34, 197, 94, 0.15) !important;
        border: 1px solid rgba(34, 197, 94, 0.3) !important;
        padding: 4px 12px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-block;
    }
    
    /* Fine amount styling */
    .fine-amount {
        color: #ef4444 !important;
        font-weight: 600;
    }
    
    .text-success {
        color: #22c55e !important;
        font-weight: 500;
    }
    
    .form-check-label {
        color: var(--text-color) !important;
    }
    
    .stat-info h3 {
        margin: 0;
        font-size: 1.8rem;
        color: var(--text-color) !important;
    }
      .stat-info p {
        margin: 5px 0 0 0;
        color: var(--text-color-secondary) !important;
        font-size: 0.9rem;
    }

    /* Enhanced filter button styling */
    .filter-btn-modern {
        background: var(--card-bg) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color-dark) !important;
        padding: 8px 12px;
        border-radius: 6px;
        margin: 2px;
        cursor: pointer;
        transition: all 0.3s ease !important;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .filter-btn-modern.active {
        background: var(--accent-color) !important;
        color: white !important;
        border-color: var(--accent-color) !important;
    }

    .filter-btn-modern:hover {
        background: var(--accent-color) !important;
        color: white !important;
        border-color: var(--accent-color) !important;
    }

    .filter-btn-modern.warning {
        border-color: var(--danger-color) !important;
    }

    .filter-btn-modern.warning.active {
        background: var(--danger-color) !important;
        color: white !important;
        border-color: var(--danger-color) !important;
    }

    /* Status badges styling */
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        min-width: 100px;
    }
    
    .status-overdue {
        background-color: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    
    .status-due-today {
        background-color: #fd7e14;
        color: white;
        border: 1px solid #fd7e14;
    }
    
    .status-active {
        background-color: #198754;
        color: white;
        border: 1px solid #198754;
    }
    
    .status-returned {
        background-color: #6c757d;
        color: white;
        border: 1px solid #6c757d;
    }
    
    .status-pending {
        background-color: #0dcaf0;
        color: white;
        border: 1px solid #0dcaf0;
    }
    
    /* Modal dark theme fixes */
    .modal-content {
        background-color: var(--card-bg) !important;
        border: 1px solid var(--border-color-dark) !important;
        color: var(--text-color) !important;
    }
    
    .modal-header {
        border-bottom: 1px solid var(--border-color-dark) !important;
    }
    
    .modal-footer {
        border-top: 1px solid var(--border-color-dark) !important;
    }
    
    .form-control, .form-select {
        background-color: var(--bg-secondary-dark) !important;
        border: 1px solid var(--border-color-dark) !important;
        color: var(--text-color) !important;
    }
      .form-control:focus, .form-select:focus {
        background-color: var(--bg-secondary-dark) !important;
        border-color: var(--accent-color) !important;
        color: var(--text-color) !important;
        box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25) !important;
    }    /* Action button group styling */
    .btn-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        margin: 0;
        white-space: nowrap;
    }
    
    .dipinjam-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        align-items: center;
    }
    
    .status-only {
        text-align: center;
        font-weight: 600;
    }
    
    /* Make sure buttons are responsive */
    @media (max-width: 768px) {
        .btn-group, .dipinjam-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn-group .btn, .dipinjam-actions .btn {
            width: 100%;
            margin-bottom: 0.25rem;
        }
    }
</style>

<div class="content-header">
                <h1>üìñ Kelola Peminjaman</h1>
            </div>

            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="alert alert-success">
                        {% for message in messages %}
                            <p>{{ message }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Loan Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-info">
                        <h3>{{ loans|length }}</h3>
                        <p>Total Peminjaman</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìñ</div>
                    <div class="stat-info">
                        <h3>{{ loans|selectattr('status', 'equalto', 'dipinjam')|list|length }}</h3>
                        <p>Aktif Dipinjam</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-info">
                        <h3 id="due-today-count">0</h3>
                        <p>Jatuh Tempo Hari Ini</p>
                    </div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-icon">üö®</div>
                    <div class="stat-info">
                        <h3 id="overdue-count">0</h3>
                        <p>Terlambat</p>
                    </div>
                </div>
            </div>            <!-- Search and Filter -->
            <div class="search-filter-section-modern">
                <div class="search-container-enhanced">
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="search-input" placeholder="Cari peminjaman... (nama siswa, judul buku, dll)" class="search-input-enhanced" style="background-color: var(--bg-secondary-dark); color: var(--text-color); border-color: var(--border-color-dark);">
                    </div>
                </div>                  <div class="filter-container-enhanced">
                    <h3 class="filter-title">üìÇ Filter Peminjaman</h3>
                    <div class="filter-buttons-modern">
                        <button class="filter-btn-modern active" data-filter="all">
                            <span class="btn-icon">üìã</span>
                            <span class="btn-text">Semua</span>
                            <span class="btn-count" id="count-all">{{ loans|length }}</span>
                        </button>
                        <button class="filter-btn-modern" data-filter="dipinjam">
                            <span class="btn-icon">üìñ</span>
                            <span class="btn-text">Dipinjam</span>
                            <span class="btn-count" id="count-dipinjam">{{ loans|selectattr('status', 'equalto', 'dipinjam')|list|length }}</span>
                        </button>
                        <button class="filter-btn-modern" data-filter="dikembalikan">
                            <span class="btn-icon">‚úÖ</span>
                            <span class="btn-text">Dikembalikan</span>
                            <span class="btn-count" id="count-dikembalikan">{{ loans|selectattr('status', 'equalto', 'dikembalikan')|list|length }}</span>
                        </button>
                        <button class="filter-btn-modern warning" data-filter="terlambat">
                            <span class="btn-icon">üö®</span>
                            <span class="btn-text">Terlambat</span>
                            <span class="btn-count" id="count-terlambat">0</span>
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <div class="table-container">
                <table id="loans-table">
                    <thead>                        <tr>
                            <th>ID</th>
                            <th>Siswa</th>
                            <th>Buku</th>
                            <th>Tgl Pinjam</th>
                            <th>Batas Kembali</th>
                            <th>Tgl Kembali</th>
                            <th>Status</th>
                            <th>Denda</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                {% for loan in loans %}
                        <tr class="loan-row" 
                            data-status="{{ loan.status }}"
                            data-member="{{ loan.user.nama_lengkap|lower }}"
                            data-book="{{ loan.buku.judul|lower }}"
                            data-class="{{ loan.user.kelas|lower }}"
                            data-due-date="{{ loan.tanggal_kembali_rencana.strftime('%Y-%m-%d') }}">                            <td data-label="ID">{{ loan.id }}</td>                            <td data-label="Siswa">
                                <div class="siswa-info">
                                    <strong>{{ loan.user.nama_lengkap }}</strong>
                                    <span class="class-badge">{{ loan.user.kelas }}</span>
                                </div>
                            </td>
                            <td data-label="Buku">
                                <div class="book-info">
                                    <strong>{{ loan.buku.judul }}</strong>
                                    <small>{{ loan.buku.penulis }}</small>
                                </div>
                            </td>
                            <td data-label="Tgl Pinjam">{{ loan.tanggal_pinjam.strftime('%d/%m/%Y') }}</td>
                            <td data-label="Batas Kembali">
                                <span class="due-date" data-due="{{ loan.tanggal_kembali_rencana.strftime('%Y-%m-%d') }}">
                                    {{ loan.tanggal_kembali_rencana.strftime('%d/%m/%Y') }}
                                </span>
                            </td>
                            <td data-label="Tgl Kembali">
                                {% if loan.tanggal_kembali_aktual %}
                                    {{ loan.tanggal_kembali_aktual.strftime('%d/%m/%Y') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>                            <td data-label="Status">
                                {% if loan.status == 'dipinjam' %}
                                    {% if not loan.tanggal_kembali_aktual %}
                                        {% if loan.tanggal_kembali_rencana.date() < today %}
                                            <span class="status-badge status-overdue">üö® Terlambat</span>
                                        {% elif loan.tanggal_kembali_rencana.date() == today %}
                                            <span class="status-badge status-due-today">‚è∞ Jatuh Tempo Hari Ini</span>
                                        {% else %}
                                            <span class="status-badge status-active">üìñ Dipinjam</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-badge status-active">üìñ Dipinjam</span>
                                    {% endif %}
                                {% elif loan.status == 'dikembalikan' %}
                                    <span class="status-badge status-returned">‚úÖ Dikembalikan</span>
                                {% elif loan.status == 'menunggu_konfirmasi' %}
                                    <span class="status-badge status-pending">‚è≥ Menunggu Konfirmasi</span>
                                {% endif %}
                            </td>                            <td data-label="Denda">
                                {% if loan.denda > 0 %}
                                    <span class="fine-amount">üí∞ Rp {{ "{:,}".format(loan.denda) }}</span>
                                {% elif loan.status == 'dikembalikan' and loan.denda == 0 %}
                                    <span class="text-success">‚úÖ Lunas/Gratis</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td><td data-label="Aksi" class="aksi-column">
                                {% if loan.status == 'dipinjam' %}
                                    <!-- Tombol untuk filter dipinjam/terlambat -->
                                    <div class="dipinjam-actions">
                                        <a href="{{ url_for('admin_return_book', id=loan.id) }}" 
                                           class="btn btn-sm btn-success btn-kembalikan"
                                           onclick="return confirm('Proses pengembalian buku?')">
                                            üîÑ Kembalikan
                                        </a>
                                        <!-- Tombol Kelola Denda untuk semua buku dipinjam -->
                                        <button type="button" class="btn btn-sm btn-warning btn-kelola-denda" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#kelolaDendaModal"
                                                data-loan-id="{{ loan.id }}"
                                                data-loan-member="{{ loan.user.nama_lengkap }}"
                                                data-loan-book="{{ loan.buku.judul }}"
                                                data-loan-due-date="{{ loan.tanggal_kembali_rencana.strftime('%d/%m/%Y') }}"
                                                data-loan-fine="{{ loan.denda }}">
                                            üí∞ Kelola Denda
                                        </button>
                                    </div>                                    <!-- Status untuk filter semua -->
                                    <div class="status-only" style="display: none;">
                                        <span class="status-info">üìñ Aktif</span>
                                    </div>
                                {% elif loan.status == 'dikembalikan' %}
                                    <!-- Tombol untuk filter dikembalikan -->
                                    <div class="dikembalikan-actions">
                                        <span class="btn-selesai">‚úÖ Selesai</span>
                                    </div>
                                    <!-- Status untuk filter semua -->
                                    <div class="status-only" style="display: none;">
                                        <span class="status-info">‚úÖ Selesai</span>
                                    </div>
                                {% elif loan.status == 'menunggu_konfirmasi' %}
                                    <div class="btn-group">
                                        <a href="{{ url_for('admin_approve_loan', id=loan.id) }}" 
                                           class="btn btn-sm btn-primary"
                                           onclick="return confirm('Konfirmasi peminjaman ini?')">
                                            ‚úÖ Konfirmasi
                                        </a>
                                        <a href="{{ url_for('admin_reject_loan', id=loan.id) }}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Tolak peminjaman ini?')">
                                            ‚ùå Tolak
                                        </a>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if not loans %}            <div class="no-data">
                <div class="no-data-icon">üìö</div>
                <h3>Belum ada data peminjaman</h3>
                <p>Mulai proses peminjaman buku untuk siswa.</p>
                <a href="{{ url_for('admin_process_loan') }}" class="btn btn-primary">‚ö° Proses Peminjaman Baru</a>
            </div>
            {% endif %}        </div>
    </div>

    <!-- Modal Kelola Denda -->
    <div class="modal fade" id="kelolaDendaModal" tabindex="-1" aria-labelledby="kelolaDendaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="kelolaDendaModalLabel">üí∞ Kelola Denda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informasi Peminjaman (Read-only) -->
                    <div class="mb-4 p-3" style="background: var(--bg-secondary-dark); border-radius: 8px; border: 1px solid var(--border-color-dark);">
                        <h6 class="mb-3">üìã Informasi Peminjaman</h6>
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>ID Peminjaman:</strong> <span id="modal-loan-id"></span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Nama Siswa:</strong> <span id="modal-loan-member"></span>
                            </div>
                            <div class="col-sm-6 mt-2">
                                <strong>Judul Buku:</strong> <span id="modal-loan-book"></span>
                            </div>
                            <div class="col-sm-6 mt-2">
                                <strong>Batas Kembali:</strong> <span id="modal-loan-due-date"></span>
                            </div>
                        </div>
                    </div>
                      <!-- Form Kelola Denda -->
                    <form id="formKelolaDenda" method="POST" action="{{ url_for('admin_manage_fine') }}">
                        <input type="hidden" name="loan_id" id="form-loan-id">
                          <div class="mb-3">
                            <label for="denda" class="form-label">üí∞ Jumlah Denda (Rp)</label>
                            <input type="text" class="form-control" id="denda" name="denda" 
                                   required
                                   placeholder="Contoh: 10000 atau 10.000" 
                                   pattern="[0-9.,]*"
                                   title="Masukkan angka saja, boleh dengan pemisah ribuan (titik atau koma)">
                            <div class="form-text" style="color: var(--text-secondary-dark);">
                                üìù Masukkan jumlah denda dalam rupiah. Boleh menggunakan pemisah ribuan (10.000 atau 10,000)
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="status_denda" class="form-label">üìä Status Denda</label>
                            <select class="form-select" id="status_denda" name="status_denda" required>
                                <option value="Belum Lunas">Belum Lunas</option>
                                <option value="Lunas">Lunas</option>
                                <option value="Dihapuskan/Gratis">Dihapuskan/Gratis</option>
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="kembalikan_buku_juga" name="kembalikan_buku_juga">
                            <label class="form-check-label" for="kembalikan_buku_juga">
                                üìö Tandai Buku Sebagai Dikembalikan Juga?
                            </label>
                            <div class="form-text" style="color: var(--text-secondary-dark);">
                                Centang jika buku juga dikembalikan bersamaan dengan pengelolaan denda
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" form="formKelolaDenda" class="btn btn-primary">üíæ Simpan Perubahan Denda</button>
                </div>
            </div>
        </div>
    </div>

    <script>        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setupSearch();
            // setupFilters(); // Diganti dengan robust filter fix
            highlightOverdueLoans();
            setupKelolaDendaModal();
        });// Update statistics
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            let dueTodayCount = 0;
            let overdueCount = 0;

            document.querySelectorAll('.loan-row').forEach(row => {
                const status = row.dataset.status;
                const dueDate = row.dataset.dueDate;
                
                // Update status badge dinamis
                const statusBadge = row.querySelector('.status-badge');
                if (status === 'dipinjam' && statusBadge) {
                    if (dueDate < today) {
                        statusBadge.textContent = 'üö® Terlambat';
                        statusBadge.className = 'status-badge status-overdue';
                        overdueCount++;
                        row.classList.add('overdue');
                        row.classList.remove('due-today');
                    } else if (dueDate === today) {
                        statusBadge.textContent = '‚è∞ Jatuh Tempo Hari Ini';
                        statusBadge.className = 'status-badge status-due-today';
                        dueTodayCount++;
                        row.classList.add('due-today');
                        row.classList.remove('overdue');
                    } else {
                        statusBadge.textContent = 'üìñ Dipinjam';
                        statusBadge.className = 'status-badge status-active';
                        row.classList.remove('overdue', 'due-today');
                    }
                }
            });            // Update main stats
            document.getElementById('due-today-count').textContent = dueTodayCount;
            document.getElementById('overdue-count').textContent = overdueCount;
            
            // Update count with animation
            updateFilterCounts();
        }        // Setup modal Kelola Denda
        function setupKelolaDendaModal() {
            const kelolaDendaModal = document.getElementById('kelolaDendaModal');
            const formKelolaDenda = document.getElementById('formKelolaDenda');
            const dendaInput = document.getElementById('denda');
            
            // Format input denda dengan thousands separator
            if (dendaInput) {
                dendaInput.addEventListener('input', function(e) {
                    let value = e.target.value;
                    
                    // Remove all non-digit characters except dots and commas
                    value = value.replace(/[^0-9.,]/g, '');
                    
                    // Remove multiple consecutive separators
                    value = value.replace(/[.,]{2,}/g, '.');
                    
                    // Update the input value
                    e.target.value = value;
                });
                
                // Format on blur for better visual
                dendaInput.addEventListener('blur', function(e) {
                    let value = e.target.value;
                    
                    // Clean the value
                    value = value.replace(/[^0-9]/g, '');
                    
                    if (value) {
                        // Format with thousands separator
                        const formatted = parseInt(value).toLocaleString('id-ID');
                        e.target.value = formatted;
                    }
                });
                
                // Clean format on focus for editing
                dendaInput.addEventListener('focus', function(e) {
                    let value = e.target.value;
                    
                    // Remove thousands separators for editing
                    value = value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                });
            }
            
            if (kelolaDendaModal) {
                kelolaDendaModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    
                    // Ambil data dari atribut data-*
                    const loanId = button.getAttribute('data-loan-id');
                    const loanMember = button.getAttribute('data-loan-member');
                    const loanBook = button.getAttribute('data-loan-book');
                    const loanDueDate = button.getAttribute('data-loan-due-date');
                    const loanFine = parseInt(button.getAttribute('data-loan-fine')) || 0;
                    
                    // Isi informasi peminjaman
                    document.getElementById('modal-loan-id').textContent = loanId;
                    document.getElementById('modal-loan-member').textContent = loanMember;
                    document.getElementById('modal-loan-book').textContent = loanBook;
                    document.getElementById('modal-loan-due-date').textContent = loanDueDate;
                    
                    // Isi form
                    document.getElementById('form-loan-id').value = loanId;
                    const dendaInput = document.getElementById('denda');
                    
                    // Hitung denda otomatis jika belum ada
                    if (loanFine === 0) {
                        const calculatedFine = calculateAutomaticFine(loanDueDate);
                        dendaInput.value = calculatedFine;
                    } else {
                        dendaInput.value = loanFine;
                    }
                      // Set action form
                    formKelolaDenda.action = "{{ url_for('admin_manage_fine') }}";
                });
                
                // Handle form submission untuk refresh filter
                formKelolaDenda.addEventListener('submit', function(e) {
                    // Form akan submit seperti biasa
                    // Setelah page reload, filter fix akan auto-setup
                });
            }
        }
        
        // Hitung denda otomatis berdasarkan keterlambatan
        function calculateAutomaticFine(dueDateString) {
            const today = new Date();
            const dueDate = new Date(dueDateString.split('/').reverse().join('-')); // Convert DD/MM/YYYY to YYYY-MM-DD
            
            if (today > dueDate) {
                const diffTime = Math.abs(today - dueDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays * 1000; // Rp 1000 per hari
            }
            
            return 0;
        }        // Update filter counts including pending loans
        function updateFilterCounts() {
            const allRows = document.querySelectorAll('.loan-row');
            const today = new Date().toISOString().split('T')[0];
            
            // Count different statuses
            let allCount = allRows.length;
            let dipinjamCount = 0;
            let dikembalikanCount = 0;
            let terlambatCount = 0;
            
            allRows.forEach(row => {
                const status = row.dataset.status;
                const dueDate = row.dataset.dueDate;
                
                if (status === 'dipinjam') {
                    dipinjamCount++;
                    if (dueDate < today) {
                        terlambatCount++;
                    }
                } else if (status === 'dikembalikan') {
                    dikembalikanCount++;
                }
            });
            
            // Update counts with animation
            animateCountUpdate('count-all', allCount);
            animateCountUpdate('count-dipinjam', dipinjamCount);
            animateCountUpdate('count-dikembalikan', dikembalikanCount);
            animateCountUpdate('count-terlambat', terlambatCount);
        }
        
        // Animate count update
        function animateCountUpdate(elementId, newCount) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    element.textContent = newCount;
                    element.style.transform = 'scale(1)';
                }, 150);
            }
        }        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                document.querySelectorAll('.loan-row').forEach(row => {
                    const member = row.dataset.member;
                    const book = row.dataset.book;
                    const className = row.dataset.class;
                    
                    const matches = member.includes(searchTerm) || 
                                  book.includes(searchTerm) || 
                                  className.includes(searchTerm);
                    
                    row.style.display = matches ? '' : 'none';
                });
                
                // Update filter counts after search
                setTimeout(updateFilterCounts, 100);
            });
        }        // Setup filter functionality
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn-modern');
            const today = new Date().toISOString().split('T')[0];
            
            console.log('Setting up filters, found buttons:', filterButtons.length);
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Filter clicked:', this.dataset.filter);
                    
                    // Remove active class from all buttons
                    filterButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    let visibleCount = 0;
                    
                    document.querySelectorAll('.loan-row').forEach(row => {
                        const status = row.dataset.status;
                        const dueDate = row.dataset.dueDate;
                        let show = false;
                        
                        switch(filter) {
                            case 'all':
                                show = true;
                                // Untuk filter "semua", sembunyikan tombol aksi dipinjam dan tampilkan status saja
                                toggleActionButtons(row, 'all');
                                break;
                            case 'dipinjam':
                                show = status === 'dipinjam';
                                // Untuk filter "dipinjam", tampilkan tombol aksi
                                toggleActionButtons(row, 'dipinjam');
                                break;
                            case 'dikembalikan':
                                show = status === 'dikembalikan';
                                toggleActionButtons(row, 'dikembalikan');
                                break;
                            case 'terlambat':
                                show = status === 'dipinjam' && dueDate < today;
                                // Untuk filter "terlambat", tampilkan tombol aksi dengan fokus kelola denda
                                toggleActionButtons(row, 'terlambat');
                                break;
                        }
                        
                        if (show) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    console.log('Filter applied:', filter, 'Visible rows:', visibleCount);
                    
                    // Show notification
                    showFilterNotification(filter, visibleCount);
                });
            });        }
          // Toggle action buttons based on active filter        function toggleActionButtons(row, filterType) {
            const dipinjamActions = row.querySelector('.dipinjam-actions');
            const dikembalikanActions = row.querySelector('.dikembalikan-actions');
            const statusOnly = row.querySelector('.status-only');
            const kembalikanBtn = row.querySelector('.btn-kembalikan');
            const kelolaDendaBtn = row.querySelector('.btn-kelola-denda');
            
            // Hide all action containers first
            if (dipinjamActions) dipinjamActions.style.display = 'none';
            if (dikembalikanActions) dikembalikanActions.style.display = 'none';
            if (statusOnly) statusOnly.style.display = 'none';
            
            if (filterType === 'all') {
                // Untuk filter "semua", tampilkan status saja
                if (statusOnly) statusOnly.style.display = 'block';
            } else if (filterType === 'dipinjam') {
                // Untuk filter "dipinjam", tampilkan tombol kembalikan saja
                if (dipinjamActions) {
                    dipinjamActions.style.display = 'flex';
                    if (kembalikanBtn) kembalikanBtn.style.display = 'inline-block';
                    if (kelolaDendaBtn) kelolaDendaBtn.style.display = 'none';
                }
            } else if (filterType === 'dikembalikan') {
                // Untuk filter "dikembalikan", tampilkan tombol selesai
                if (dikembalikanActions) dikembalikanActions.style.display = 'block';
            } else if (filterType === 'terlambat') {
                // Untuk filter "terlambat", hanya tampilkan tombol kelola denda
                if (dipinjamActions) {
                    dipinjamActions.style.display = 'flex';
                    if (kembalikanBtn) kembalikanBtn.style.display = 'none';
                    if (kelolaDendaBtn) kelolaDendaBtn.style.display = 'inline-block';
                }
            } else {
                // Default case
                if (dipinjamActions) dipinjamActions.style.display = 'flex';
                if (dikembalikanActions) dikembalikanActions.style.display = 'block';
            }
        }
        
        // Show filter notification
        function showFilterNotification(filter, count) {
            const filterNames = {
                'all': 'Semua Peminjaman',
                'dipinjam': 'Sedang Dipinjam',
                'dikembalikan': 'Sudah Dikembalikan',
                'terlambat': 'Terlambat'
            };
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'filter-notification';
            notification.innerHTML = `
                <span class="notification-icon">üìä</span>
                <span class="notification-text">Menampilkan ${count} ${filterNames[filter]}</span>
            `;
            
            // Add notification styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 600;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }        // Highlight overdue loans
        function highlightOverdueLoans() {
            const today = new Date().toISOString().split('T')[0];
            
            document.querySelectorAll('.due-date').forEach(element => {
                const dueDate = element.dataset.due;
                if (dueDate < today) {
                    element.classList.add('overdue-date');
                } else if (dueDate === today) {
                    element.classList.add('due-today-date');
                }            });
        }
    </script>

    <!-- Include filter fix script -->
    <script src="{{ url_for('static', filename='js/loans-filter-fix.js') }}"></script>
    
    <script>
        // Handle form submission dengan filter fix
        document.addEventListener('DOMContentLoaded', function() {
            const kelolaDendaForm = document.getElementById('kelolaDendaForm');
            if (kelolaDendaForm) {
                kelolaDendaForm.addEventListener('submit', function() {
                    // Setelah form submit berhasil, force refresh filter
                    setTimeout(() => {
                        if (window.loansFilterFix) {
                            window.loansFilterFix.forceRefreshStats();
                            window.loansFilterFix.setupRobustFilters();
                            window.loansFilterFix.resetFiltersToAll();
                        }
                    }, 1000);
                });
            }
        });
    </script>
{% endblock %}
